name: Build And Deploy Backstage Image (ECR)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: backstage-app
  GITOPS_REPO: SAMJOYAP/gitops
  APP_NAME: backstage-kr
  GITOPS_VALUES_FILE: apps/backstage-kr/values-kr.yaml

jobs:
  build-push-and-update-gitops:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release version from Git tag
        id: version
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          BASE_TAG="$(git describe --tags --abbrev=0 --match 'v[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true)"
          if [[ -z "${BASE_TAG}" ]]; then
            BASE_TAG="$(git describe --tags --abbrev=0 --match '[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true)"
          fi

          if [[ -z "${BASE_TAG}" ]]; then
            echo "No semver Git tag found. Create a tag like v1.0.0 first."
            exit 1
          fi

          BASE_VERSION="${BASE_TAG#v}"
          EXACT_TAG="$(git tag --points-at HEAD | grep -E '^(v)?[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || true)"
          SHORT_SHA="${GITHUB_SHA::7}"

          if [[ -n "${EXACT_TAG}" ]]; then
            VERSION="${EXACT_TAG#v}"
          else
            VERSION="${BASE_VERSION}-${SHORT_SHA}"
          fi

          echo "tag=${BASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Resolved VERSION=${VERSION} from BASE_TAG=${BASE_TAG}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: image
        shell: bash
        run: |
          set -euo pipefail
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          IMAGE="${REGISTRY}/${{ env.ECR_REPOSITORY }}:${{ steps.version.outputs.version }}"
          echo "registry=${REGISTRY}" >> "$GITHUB_OUTPUT"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "Using image: ${IMAGE}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push (linux/amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ${{ steps.image.outputs.image }}

      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          ref: main
          path: gitops-repo

      - name: Bootstrap backstage-kr values and manifests
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="gitops-repo/apps/${APP_NAME}"
          MANIFEST_DIR="${APP_DIR}/manifests"
          mkdir -p "${MANIFEST_DIR}"

          if [[ ! -f "${APP_DIR}/values.yaml" ]]; then
            {
              echo "# Ref: https://github.com/backstage/charts/tree/main/charts/backstage"
              echo "ingress:"
              echo "  enabled: true"
              echo "  className: \"nginx\""
              echo "  extraHosts: []"
              echo "  path: \"/\""
              echo "  tls:"
              echo "    enabled: true"
              echo "    secretName: \"backstage-server-tls\""
              echo "backstage:"
              echo "  replicas: 1"
              echo "  image:"
              echo "    registry: ghcr.io"
              echo "    repository: cnoe-io/backstage-app"
              echo "    tag: latest"
              echo "    pullPolicy: IfNotPresent"
              echo "  command: [\"node\", \"packages/backend\"]"
              echo "postgresql:"
              echo "  enabled: true"
              echo "serviceAccount:"
              echo "  create: true"
            } > "${APP_DIR}/values.yaml"
          fi

          if [[ ! -f "${APP_DIR}/values-kr.yaml" ]]; then
            {
              echo "ingress:"
              echo "  tls:"
              echo "    secretName: \"backstage-kr-server-tls\""
              echo "backstage:"
              echo "  appConfig:"
              echo "    app:"
              echo "      title: ALREADY11 Backstage"
              echo "    organization:"
              echo "      name: ALREADY11"
              echo "  image:"
              echo "    registry: REPLACE_ECR_REGISTRY"
              echo "    repository: REPLACE_ECR_REPOSITORY"
              echo "    tag: REPLACE_ECR_TAG"
            } > "${APP_DIR}/values-kr.yaml"
          fi

          if [[ ! -f "${APP_DIR}/kustomization.yaml" ]]; then
            {
              echo "apiVersion: kustomize.config.k8s.io/v1beta1"
              echo "kind: Kustomization"
              echo "resources:"
              echo "  - manifests/external-secrets.yaml"
              echo "  - manifests/k8s-config-secret.yaml"
            } > "${APP_DIR}/kustomization.yaml"
          fi

          if [[ ! -f "${MANIFEST_DIR}/external-secrets.yaml" ]]; then
            {
              echo "apiVersion: external-secrets.io/v1"
              echo "kind: ExternalSecret"
              echo "metadata:"
              echo "  name: backstage-auth-secret"
              echo "  namespace: ${APP_NAME}"
              echo "spec:"
              echo "  refreshInterval: 15m"
              echo "  secretStoreRef:"
              echo "    kind: ClusterSecretStore"
              echo "    name: aws-secretsmanager"
              echo "  target:"
              echo "    name: backstage-auth-secret"
              echo "    creationPolicy: Owner"
              echo "  data:"
              echo "    - secretKey: AUTH_KEYCLOAK_CLIENT_SECRET"
              echo "      remoteRef:"
              echo "        key: cnoe-ref-impl/config"
              echo "        property: AUTH_KEYCLOAK_CLIENT_SECRET"
              echo "    - secretKey: GITHUB_TOKEN"
              echo "      remoteRef:"
              echo "        key: cnoe-ref-impl/config"
              echo "        property: GITHUB_TOKEN"
            } > "${MANIFEST_DIR}/external-secrets.yaml"
          fi

          if [[ ! -f "${MANIFEST_DIR}/k8s-config-secret.yaml" ]]; then
            {
              echo "apiVersion: external-secrets.io/v1"
              echo "kind: ExternalSecret"
              echo "metadata:"
              echo "  name: backstage-k8s-secret"
              echo "  namespace: ${APP_NAME}"
              echo "spec:"
              echo "  refreshInterval: 15m"
              echo "  secretStoreRef:"
              echo "    kind: ClusterSecretStore"
              echo "    name: aws-secretsmanager"
              echo "  target:"
              echo "    name: backstage-k8s-secret"
              echo "    creationPolicy: Owner"
              echo "  data:"
              echo "    - secretKey: K8S_CONFIG"
              echo "      remoteRef:"
              echo "        key: cnoe-ref-impl/k8s/config"
              echo "        property: config"
            } > "${MANIFEST_DIR}/k8s-config-secret.yaml"
          fi

      - name: Update GitOps backstage image values
        id: gitops_changes
        env:
          VERSION: ${{ steps.version.outputs.version }}
          ECR_REGISTRY: ${{ steps.image.outputs.registry }}
        shell: bash
        run: |
          set -euo pipefail
          VALUES_FILE="gitops-repo/${GITOPS_VALUES_FILE}"
          if [[ ! -f "${VALUES_FILE}" ]]; then
            echo "GitOps values file not found: ${VALUES_FILE}"
            exit 1
          fi
          sed -i -E "s|^([[:space:]]*registry:).*|\\1 ${ECR_REGISTRY}|" "${VALUES_FILE}"
          sed -i -E "s|^([[:space:]]*repository:).*|\\1 ${ECR_REPOSITORY}|" "${VALUES_FILE}"
          sed -i -E "s|^([[:space:]]*tag:).*|\\1 ${VERSION}|" "${VALUES_FILE}"

          if git -C gitops-repo diff --quiet -- "apps/${APP_NAME}"; then
            echo "No GitOps change needed."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request in GitOps repo
        id: create_pr
        if: steps.gitops_changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops-repo
          commit-message: "chore(backstage-kr): deploy backstage-app:${{ steps.version.outputs.version }} [skip ci]"
          title: "chore(backstage-kr): deploy backstage-app:${{ steps.version.outputs.version }}"
          body: |
            Automated GitOps update for backstage-kr image.
          branch: chore/cd-update-backstage-kr-image
          base: main
          delete-branch: true
          add-paths: |
            apps/backstage-kr/values.yaml
            apps/backstage-kr/values-kr.yaml
            apps/backstage-kr/kustomization.yaml
            apps/backstage-kr/manifests/external-secrets.yaml
            apps/backstage-kr/manifests/k8s-config-secret.yaml

      - name: Enable auto-merge for GitOps PR
        if: steps.gitops_changes.outputs.changed == 'true' && steps.create_pr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN }}
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
        shell: bash
        run: |
          if ! gh pr merge "$PR_NUMBER" --auto --squash --repo "${GITOPS_REPO}"; then
            echo "Auto-merge is unavailable. Trying immediate squash merge."
            gh pr merge "$PR_NUMBER" --squash --repo "${GITOPS_REPO}" || \
              echo "Merge is still pending. Please merge PR #$PR_NUMBER manually."
          fi

      - name: Summary
        run: |
          echo "Deployed image tag: ${{ steps.version.outputs.version }}"
          echo "Image: ${{ steps.image.outputs.image }}"
